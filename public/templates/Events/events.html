{% extends "base.html" %}

{% block title %}Events{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('protected_css', filename='events.css') }}">
<style nonce="{{ csp_nonce }}">
    .event-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    .event-actions .btn {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Add Button and Search Bar -->
    <div class="top-controls">
        <a href="{{ url_for('event_add') }}" class="btn btn-danger">+ Add an Event</a>
        <div class="input-group" style="width: 60%;">
            <input type="text" id="searchInput" class="form-control" placeholder="Search for an activity" />
            <button id="searchBtn" class="btn btn-danger">Search</button>
        </div>
        <button id="filterBtn" class="btn btn-outline-secondary">Filter</button>
    </div>

    <div id="eventList" class="container mt-4"></div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this event? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    // Fetch events from API endpoint
    async function fetchEvents() {
        try {
            const response = await fetch('{{ url_for("api_events") }}');
            if (!response.ok) {
                throw new Error('Failed to fetch events');
            }
            const data = await response.json();
            return data.events;
        } catch (error) {
            console.error('Error fetching events:', error);
            return [];
        }
    }

    function renderEvents(events) {
        const container = document.getElementById("eventList");
        container.innerHTML = ""; // Clear previous contents

        if (events.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No events found. Be the first to <a href="{{ url_for('event_add') }}">add an event</a>!
                </div>
            `;
            return;
        }

        events.forEach(event => {
            const card = document.createElement("div");
            card.className = "card mb-3";
            
            // Create action buttons HTML based on user's relationship to the event
            let actionsHtml = '';
            
            // If user is the owner, show edit and delete buttons
            if (event.is_owner) {
                actionsHtml = `
                    <div class="event-actions">
                        <a href="{{ url_for('event_edit', event_id=0) }}`.replace('0', event.id) + `" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <button class="btn btn-sm btn-outline-danger delete-event" data-event-id="${event.id}" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                `;
            } 
            // If user is not the owner, show signup or cancel buttons
            else {
                if (event.is_signed_up) {
                    // User is already signed up, show cancel button
                    actionsHtml = `
                        <div class="event-actions">
                            <form action="{{ url_for('event_cancel', event_id=0) }}`.replace('0', event.id) + `" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-calendar-x"></i> Cancel Registration
                                </button>
                            </form>
                        </div>
                    `;
                } else {
                    // User is not signed up, show signup button if there's vacancy
                    const isFull = event.signed_up_count >= event.vacancy;
                    if (isFull) {
                        actionsHtml = `
                            <div class="event-actions">
                                <button class="btn btn-sm btn-outline-secondary" disabled>
                                    <i class="bi bi-calendar-x"></i> Event Full
                                </button>
                            </div>
                        `;
                    } else {
                        actionsHtml = `
                            <div class="event-actions">
                                <form action="{{ url_for('event_signup', event_id=0) }}`.replace('0', event.id) + `" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-success">
                                        <i class="bi bi-calendar-plus"></i> Sign Up
                                    </button>
                                </form>
                            </div>
                        `;
                    }
                }
            }
            
            // Calculate availability status and badge color
            const availableSpots = event.vacancy - event.signed_up_count;
            const availabilityText = `${availableSpots} / ${event.vacancy} available`;
            let badgeClass = 'bg-success';
            
            if (availableSpots === 0) {
                badgeClass = 'bg-danger';
            } else if (availableSpots <= event.vacancy * 0.2) { // Less than 20% spots left
                badgeClass = 'bg-warning text-dark';
            }
            
            // Add a special badge if user is signed up
            const signupBadge = event.is_signed_up ? 
                `<span class="badge bg-primary ms-2">You're registered</span>` : '';
            
            card.innerHTML = `
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="${event.image}" class="img-fluid rounded-start" alt="Event Image">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title">${event.title}</h5>
                            <p class="card-text mb-1"><strong>${event.category}</strong> • From ${event.price} • ${event.sessions} sessions</p>
                            <p class="card-text mb-1">
                                <span class="badge ${badgeClass}">${availabilityText}</span>
                                ${signupBadge}
                                <span class="badge bg-info text-dark">${event.intensity}</span>
                            </p>
                            <p class="card-text mb-1"><i class="bi bi-geo-alt"></i> ${event.location}</p>
                            <p class="card-text mb-1"><i class="bi bi-calendar-event"></i> Starts ${event.date}</p>
                            <p class="card-text"><i class="bi bi-clock"></i> ${event.time}</p>
                            ${actionsHtml}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-event').forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                document.getElementById('deleteForm').action = `{{ url_for('event_delete', event_id=0) }}`.replace('0', eventId);
            });
        });
    }

    // Search functionality
    document.getElementById('searchBtn').addEventListener('click', function() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        filterEvents(searchTerm);
    });

    document.getElementById('searchInput').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            const searchTerm = this.value.toLowerCase();
            filterEvents(searchTerm);
        }
    });

    async function filterEvents(searchTerm) {
        const events = await fetchEvents();
        if (!searchTerm) {
            renderEvents(events);
            return;
        }

        const filtered = events.filter(event => 
            event.title.toLowerCase().includes(searchTerm) ||
            event.category.toLowerCase().includes(searchTerm) ||
            event.location.toLowerCase().includes(searchTerm)
        );

        renderEvents(filtered);
    }

    // Run on page load
    (async function() {
        const events = await fetchEvents();
        renderEvents(events);
    })();
</script>
{% endblock %}
