{% extends "base.html" %}

{% block title %}WellNest AI Assistant - Powered by Google Gemini{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-xl-10 mx-auto">
            <!-- Header Section -->
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    ü§ñ WellNest AI Assistant
                    <small class="text-muted fs-6 d-block mt-2">Powered by Google Gemini AI</small>
                </h1>
                <p class="lead text-muted">
                    Your intelligent healthcare companion for wellness information and clinic guidance
                </p>
            </div>

            <!-- Chat Interface Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">üí¨ Chat with WellNest AI</h5>
                            <small class="opacity-75">Get instant answers to your healthcare questions</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="export-chat-btn" class="btn btn-outline-light btn-sm" title="Export Chat">
                                <i class="bi bi-download"></i>
                            </button>
                            <button id="clear-chat-btn" class="btn btn-outline-light btn-sm" title="Clear Chat">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="chat-container">
                        <!-- Messages Area -->
                        <div id="chat-messages" class="chat-messages">
                            <div class="message bot-message">
                                <div class="message-avatar">ü§ñ</div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <strong>WellNest AI</strong>
                                        <small class="text-muted">Just now</small>
                                    </div>
                                    <div class="message-body">
                                        <div class="welcome-message">
                                            <h6>üëã Hello, {{ user.name if user else 'there' }}!</h6>
                                            <p>I'm WellNest AI, your healthcare assistant powered by Google Gemini. I can help you with:</p>
                                            <div class="capabilities-grid">
                                                <div class="capability-item">
                                                    <i class="bi bi-heart-pulse text-danger"></i>
                                                    <span>General health information</span>
                                                </div>
                                                <div class="capability-item">
                                                    <i class="bi bi-hospital text-primary"></i>
                                                    <span>Clinic & healthcare navigation</span>
                                                </div>
                                                <div class="capability-item">
                                                    <i class="bi bi-shield-check text-success"></i>
                                                    <span>Preventive care tips</span>
                                                </div>
                                                <div class="capability-item">
                                                    <i class="bi bi-emoji-smile text-warning"></i>
                                                    <span>Mental wellness support</span>
                                                </div>
                                            </div>
                                            <p class="mt-3 mb-0">
                                                <i class="bi bi-info-circle text-info"></i>
                                                <small><strong>Important:</strong> I provide general information only. Always consult healthcare professionals for medical advice.</small>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <div class="quick-actions-label">Quick questions:</div>
                            <div class="quick-actions-buttons">
                                <button class="btn btn-outline-primary btn-sm quick-message-btn" data-message="What are the symptoms of common cold?">
                                    ü§ß Cold symptoms
                                </button>
                                <button class="btn btn-outline-primary btn-sm quick-message-btn" data-message="How do I find a clinic near me?">
                                    üè• Find clinics
                                </button>
                                <button class="btn btn-outline-primary btn-sm quick-message-btn" data-message="Tips for better sleep">
                                    üò¥ Sleep tips
                                </button>
                                <button class="btn btn-outline-primary btn-sm quick-message-btn" data-message="How to manage stress?">
                                    üßò Stress management
                                </button>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="chat-input-container">
                            <div class="input-wrapper">
                                <div class="input-group">
                                    <div class="input-group-text bg-light">
                                        <i class="bi bi-person-circle text-muted"></i>
                                    </div>
                                    <textarea
                                        id="user-input"
                                        class="form-control chat-input"
                                        rows="1"
                                        placeholder="Ask me anything about health, wellness, or finding clinics..."
                                        maxlength="2000"
                                    ></textarea>
                                    <button id="send-btn" class="btn btn-primary chat-send-btn">
                                        <i class="bi bi-send-fill"></i>
                                    </button>
                                </div>
                                <div class="input-footer">
                                    <small class="text-muted">
                                        <span id="char-count">0</span>/2000 characters
                                        <span class="mx-2">‚Ä¢</span>
                                        Press <kbd>Enter</kbd> to send, <kbd>Shift + Enter</kbd> for new line
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Features & Info Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-title text-success">
                                <i class="bi bi-shield-check-fill me-2"></i>
                                Safe & Secure
                            </h6>
                            <p class="card-text small text-muted mb-0">
                                Your conversations are processed securely with built-in safety filters and privacy protection.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-title text-info">
                                <i class="bi bi-lightning-charge-fill me-2"></i>
                                Powered by Gemini AI
                            </h6>
                            <p class="card-text small text-muted mb-0">
                                Using Google's advanced AI technology for accurate and helpful healthcare information.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style nonce="{{ csp_nonce }}">
/* Enhanced Chat Container Styles */
.chat-container {
    border-radius: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 600px;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, var(--primary-red) 0%, #dc3545 100%);
}

/* Messages Area */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Message Structure */
.message {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    max-width: 85%;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-message {
    margin-left: auto;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-red);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
}

.message-content {
    flex: 1;
    background: white;
    border-radius: 1rem;
    padding: 1rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
}

.user-message .message-content {
    background: linear-gradient(135deg, var(--primary-red) 0%, #dc3545 100%);
    color: black;
    border: none;
}

.error-message .message-content {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c2c7 100%);
    color: #721c24;
    border: 1px solid #f1aeb5;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.message-body {
    line-height: 1.6;
}

/* Welcome Message Styling */
.welcome-message h6 {
    color: var(--primary-red);
    margin-bottom: 1rem;
}

.capabilities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin: 1rem 0;
}

.capability-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(220, 53, 69, 0.05);
    border-radius: 0.5rem;
    font-size: 0.875rem;
}

/* Quick Actions */
.quick-actions {
    padding: 1rem 1.5rem 0;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

.quick-actions-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.75rem;
    font-weight: 500;
}

.quick-actions-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

/* Enhanced Input Area */
.chat-input-container {
    padding: 1.5rem;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
}

.input-wrapper {
    max-width: 100%;
}

.chat-input {
    resize: none;
    border: 2px solid #000000;
    border-radius: 1rem;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    min-height: 44px;
    max-height: 120px;
    color: #000000;
}

.chat-input:focus {
    border-color: var(--primary-red);
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
}

.input-group-text {
    border: 2px solid #dee2e6;
    border-right: none;
    border-radius: 1rem 0 0 1rem;
}

.chat-send-btn {
    border: 2px solid var(--primary-red);
    background: var(--primary-red);
    border-radius: 0 1rem 1rem 0;
    padding: 0.75rem 1.25rem;
    transition: all 0.2s ease;
}

.chat-send-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.chat-send-btn:disabled {
    background: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.input-footer {
    margin-top: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Typing indicator */
.typing-indicator {
    max-width: 60%;
}

.typing-indicator .message-content {
    background: #e9ecef;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Enhanced markdown content styling */
.message-content h1, .message-content h2, .message-content h3,
.message-content h4, .message-content h5, .message-content h6 {
    margin: 1rem 0 0.5rem 0;
    font-weight: 600;
    color: inherit;
}

.message-content h1 { font-size: 1.5em; }
.message-content h2 { font-size: 1.35em; }
.message-content h3 { font-size: 1.2em; }

.message-content p {
    margin: 0.75rem 0;
    line-height: 1.7;
}

.message-content ul, .message-content ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
}

.message-content li {
    margin: 0.5rem 0;
    line-height: 1.6;
}

.message-content code {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 0.375rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
}

.user-message .message-content code {
    background: rgba(255, 255, 255, 0.2);
}

.message-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
    font-size: 0.9em;
}

.message-content pre code {
    background: none;
    padding: 0;
}

.message-content blockquote {
    border-left: 4px solid var(--primary-red);
    margin: 1rem 0;
    padding-left: 1rem;
    color: #6c757d;
    font-style: italic;
}

.message-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.9em;
}

.message-content th, .message-content td {
    border: 1px solid #dee2e6;
    padding: 0.5rem 1rem;
    text-align: left;
}

.message-content th {
    background: rgba(220, 53, 69, 0.1);
    font-weight: 600;
}

/* Loading animations */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--primary-red);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #dc3545;
}

/* Responsive design */
@media (max-width: 768px) {
    .chat-container {
        height: 500px;
    }

    .message {
        max-width: 95%;
    }

    .capabilities-grid {
        grid-template-columns: 1fr;
    }

    .quick-actions-buttons {
        flex-direction: column;
        align-items: stretch;
    }

    .input-group {
        flex-direction: column;
    }

    .input-group-text,
    .chat-input,
    .chat-send-btn {
        border-radius: 0.5rem !important;
        border: 2px solid #dee2e6 !important;
    }

    .chat-send-btn {
        margin-top: 0.5rem;
        background: var(--primary-red) !important;
        border-color: var(--primary-red) !important;
    }
}

/* Accessibility improvements */
@media (prefers-reduced-motion: reduce) {
    .message, .typing-indicator .message-content {
        animation: none;
    }

    .chat-send-btn:hover:not(:disabled) {
        transform: none;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .message-content {
        border: 2px solid currentColor;
    }

    .chat-input {
        border-width: 3px;
    }
}
</style>

<script nonce="{{ csp_nonce }}">
// Global variables
let messageCount = 0;
let isTyping = false;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
});

function initializeChat() {
    const input = document.getElementById('user-input');
    const charCount = document.getElementById('char-count');
    const sendBtn = document.getElementById('send-btn');
    const exportBtn = document.getElementById('export-chat-btn');
    const clearBtn = document.getElementById('clear-chat-btn');
    const quickMessageBtns = document.querySelectorAll('.quick-message-btn');

    // Focus on input
    input.focus();

    // Setup send button event listener
    sendBtn.addEventListener('click', function() {
        if (!isTyping) {
            sendMessage();
        }
    });

    // Setup export chat button
    exportBtn.addEventListener('click', exportChat);

    // Setup clear chat button
    clearBtn.addEventListener('click', clearChat);

    // Setup quick message buttons
    quickMessageBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const message = this.getAttribute('data-message');
            sendQuickMessage(message);
        });
    });

    // Setup character counter
    input.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;

        // Change color as it approaches limit
        if (count > 1800) {
            charCount.className = 'text-danger fw-bold';
        } else if (count > 1500) {
            charCount.className = 'text-warning fw-bold';
        } else {
            charCount.className = 'text-muted';
        }

        // Auto-resize textarea
        this.style.height = 'auto';
        const maxHeight = 120;
        const newHeight = Math.min(this.scrollHeight, maxHeight);
        this.style.height = newHeight + 'px';
    });

    // Enhanced keyboard handling
    input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            if (!isTyping) {
                sendMessage();
            }
        }
    });
}

async function sendMessage() {
    const input = document.getElementById('user-input');
    const message = input.value.trim();

    if (!message || isTyping) return;

    const messagesContainer = document.getElementById('chat-messages');
    const sendBtn = document.getElementById('send-btn');

    // Add user message
    addMessage(message, 'user');
    input.value = '';
    input.style.height = 'auto';
    document.getElementById('char-count').textContent = '0';
    document.getElementById('char-count').className = 'text-muted';

    // Set loading state
    isTyping = true;
    sendBtn.disabled = true;
    sendBtn.classList.add('btn-loading');

    // Add enhanced typing indicator
    const typingDiv = addTypingIndicator();

    try {
        const chatUrl = '{{ url_for("chatbot_message") }}';
        
        const response = await fetch(chatUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',  // Helps identify AJAX requests
                'X-CSRFToken': '{{ csrf_token() }}'  // Add CSRF token to headers
            },
            credentials: 'same-origin',  // Ensures cookies are sent with the request
            body: JSON.stringify({ 
                message: message
            })
        });

        // Check if response is OK (status 200-299)
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.response || `Server responded with status ${response.status}`);
        }

        const data = await response.json();

        // Remove typing indicator
        if (typingDiv && typingDiv.parentNode) {
            typingDiv.remove();
        }

        // Check for error in response
        if (data.error) {
            console.error('Chat API error:', data.response);
            addMessage(`‚ùå ${data.response || 'An error occurred'}`, 'error');
        } else {
            // Add bot response
            addMessage(data.response, 'bot');

            // Log message count if available
            if (data.message_count) {
                messageCount = data.message_count;
            }
        }

    } catch (error) {
        console.error('Chat error:', error);
        if (typingDiv && typingDiv.parentNode) {
            typingDiv.remove();
        }
        
        // More specific error messages based on error type
        let errorMessage = 'üö® Connection error. Please check your internet connection and try again.';
        if (error.message.includes('Failed to fetch')) {
            errorMessage = 'üö® Could not connect to the server. Please try again later.';
        } else if (error.message) {
            errorMessage = `‚ùå ${error.message}`;
        }
        
        addMessage(errorMessage, 'error');
    }

    // Reset loading state
    isTyping = false;
    sendBtn.disabled = false;
    sendBtn.classList.remove('btn-loading');
    input.focus();
}

function sendQuickMessage(message) {
    if (isTyping) return;

    const input = document.getElementById('user-input');
    input.value = message;
    sendMessage();
}

function addMessage(text, type) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    let className = 'message ';
    let avatar = '';
    let senderName = '';
    let messageClass = '';

    switch(type) {
        case 'user':
            className += 'user-message';
            avatar = 'üë§';
            senderName = 'You';
            messageClass = 'user-message';
            // Ensure user messages are aligned to the right
            messageDiv.style.marginLeft = 'auto';
            messageDiv.style.marginRight = '0';
            break;
        case 'bot':
            className += 'bot-message';
            avatar = 'ü§ñ';
            senderName = 'WellNest AI';
            messageClass = 'bot-message';
            break;
        case 'error':
            className += 'error-message';
            avatar = '‚ö†Ô∏è';
            senderName = 'System';
            messageClass = 'error-message';
            break;
    }

    const escapedText = type === 'user' ? escapeHtml(text) : text;

    messageDiv.className = className;
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
            <div class="message-header">
                <strong>${senderName}</strong>
                <small class="text-muted">${timestamp}</small>
            </div>
            <div class="message-body">${escapedText}</div>
        </div>
    `;

    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
}

function addTypingIndicator() {
    const messagesContainer = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');

    typingDiv.className = 'message typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
            <div class="message-header">
                <strong>WellNest AI</strong>
                <small class="text-muted">typing...</small>
            </div>
            <div class="message-body">
                <em>Thinking...</em>
                <div class="spinner-border spinner-border-sm ms-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    `;

    messagesContainer.appendChild(typingDiv);
    scrollToBottom();
    return typingDiv;
}

function scrollToBottom() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
    });
}

async function clearChat() {
    if (isTyping) return;

    if (!confirm('Are you sure you want to clear the chat history?')) {
        return;
    }

    try {
        const response = await fetch('/clear_chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message bot-message">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong>WellNest AI</strong>
                            <small class="text-muted">Just now</small>
                        </div>
                        <div class="message-body">
                            <div class="welcome-message">
                                <h6>üëã Welcome back!</h6>
                                <p>Chat history cleared. How can I help you today?</p>
                                <p class="mt-3 mb-0">
                                    <i class="bi bi-info-circle text-info"></i>
                                    <small><strong>Remember:</strong> I provide general information only. Always consult healthcare professionals for medical advice.</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messageCount = 0;
        } else {
            throw new Error('Failed to clear chat');
        }
    } catch (error) {
        console.error('Error clearing chat:', error);
        alert('Failed to clear chat. Please refresh the page.');
    }
}

function exportChat() {
    const messages = document.querySelectorAll('.message');
    let chatExport = 'WellNest AI Chat Export\n';
    chatExport += '=' .repeat(30) + '\n';
    chatExport += `Exported on: ${new Date().toLocaleString()}\n\n`;

    messages.forEach((message) => {
        const sender = message.querySelector('.message-header strong')?.textContent || 'Unknown';
        const timestamp = message.querySelector('.message-header small')?.textContent || 'Unknown time';
        const content = message.querySelector('.message-body')?.textContent || '';

        chatExport += `[${timestamp}] ${sender}:\n${content}\n\n`;
    });

    const blob = new Blob([chatExport], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wellnest-chat-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add some helpful utilities for development
window.chatDebug = {
    messageCount: () => messageCount,
    isTyping: () => isTyping,
    clearHistory: clearChat,
    exportHistory: exportChat
};
</script>
{% endblock %}